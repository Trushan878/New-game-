<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Scoreboard App</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.1/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white min-h-screen p-4">
  <div class="max-w-md mx-auto">
    <h1 class="text-3xl font-bold text-center mb-6">Game Scoreboard</h1>
    
    <!-- Add Player -->
    <div class="flex gap-2 mb-4">
      <input id="newPlayerName" type="text" placeholder="New player name" class="flex-1 px-3 py-2 rounded text-black" />
      <button id="addPlayerBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">Add</button>
    </div>
    
    <!-- Player List -->
    <ul id="playerList" class="mb-6"></ul>

    <!-- Submit Button -->
    <button id="submitPoints" class="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 rounded mb-6">
      Submit Changes
    </button>

    <!-- Game History -->
    <div>
      <h2 class="text-xl font-semibold mb-2">Game History</h2>
      <ul id="historyList" class="text-sm space-y-1"></ul>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js';
    import { getDatabase, ref, onValue, set, remove, push } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBpM4GlbdT2fITZF1mcYPFiDFYQmJLDf8k",
      authDomain: "point-system-1bd8a.firebaseapp.com",
      databaseURL: "https://point-system-1bd8a-default-rtdb.firebaseio.com",
      projectId: "point-system-1bd8a",
      storageBucket: "point-system-1bd8a.appspot.com",
      messagingSenderId: "252736290960",
      appId: "1:252736290960:web:f028f2d1d0e7e48b72315c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const playersRef = ref(db, 'players');
    const historyRef = ref(db, 'history');

    const playerList = document.getElementById('playerList');
    const newPlayerNameInput = document.getElementById('newPlayerName');
    const addPlayerBtn = document.getElementById('addPlayerBtn');
    const submitBtn = document.getElementById('submitPoints');
    const historyList = document.getElementById('historyList');

    function createPlayerElement(name, points) {
      const item = document.createElement('li');
      item.innerHTML = `
        <div class="flex items-center justify-between p-2 bg-gray-800 rounded-lg mb-2">
          <span class="text-white text-lg font-semibold">${name}: <span class="text-blue-400" id="points-${name}">${points}</span></span>
          <div class="flex items-center gap-1">
            <input type="number" placeholder="Pts" class="pointsInput w-16 px-1 rounded text-black" id="input-${name}" />
            <button class="btn-decrease bg-red-500 hover:bg-red-600 text-white rounded px-2" data-name="${name}">−</button>
            <button class="btn-increase bg-green-500 hover:bg-green-600 text-white rounded px-2" data-name="${name}">+</button>
            <button class="btn-clear bg-gray-500 hover:bg-gray-600 text-white rounded px-2" data-name="${name}">✓</button>
          </div>
        </div>
      `;
      playerList.appendChild(item);
    }

    function updateUI(players) {
      playerList.innerHTML = '';
      Object.entries(players || {}).forEach(([name, data]) => {
        createPlayerElement(name, data.points);
      });
    }

    function renderHistory(history) {
      historyList.innerHTML = '';
      Object.entries(history || {}).reverse().forEach(([game, data]) => {
        const item = document.createElement('li');
        const changes = Object.entries(data.changes || {})
          .map(([player, value]) => `${player}: ${value >= 0 ? '+' + value : value}`)
          .join(', ');
        const time = data.time || '';
        item.textContent = `${time} — ${game}: ${changes}`;
        item.className = 'text-sm text-gray-400';
        historyList.appendChild(item);
      });
    }

    onValue(playersRef, snapshot => {
      const players = snapshot.val();
      updateUI(players);
    });

    onValue(historyRef, snapshot => {
      const history = snapshot.val();
      renderHistory(history);
    });

    addPlayerBtn.addEventListener('click', () => {
      const name = newPlayerNameInput.value.trim();
      if (name) {
        set(ref(db, `players/${name}`), { points: 0 });
        newPlayerNameInput.value = '';
      }
    });

    newPlayerNameInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') addPlayerBtn.click();
    });

    submitBtn.addEventListener('click', () => {
      const updates = {};
      const gameChanges = {};
      document.querySelectorAll('.pointsInput').forEach(input => {
        const name = input.id.replace('input-', '');
        const value = parseInt(input.value) || 0;
        const direction = document.querySelector(`[data-name="${name}"].selected`)?.classList.contains('btn-increase') ? 1 :
                          document.querySelector(`[data-name="${name}"].selected`)?.classList.contains('btn-decrease') ? -1 : 0;
        if (direction !== 0 && value !== 0) {
          const change = value * direction;
          const currentPoints = parseInt(document.getElementById(`points-${name}`).textContent);
          const newPoints = currentPoints + change;
          updates[name] = { points: newPoints };
          gameChanges[name] = change;
          input.value = '';
        }
      });

      if (Object.keys(updates).length > 0) {
        Object.entries(updates).forEach(([name, data]) => {
          set(ref(db, `players/${name}`), data);
        });

        const newGameKey = push(historyRef).key;
        const timestamp = new Date().toLocaleString();
        set(ref(db, `history/${newGameKey}`), { changes: gameChanges, time: timestamp });

        document.querySelectorAll('.selected').forEach(btn => btn.classList.remove('selected'));
      }
    });

    playerList.addEventListener('click', e => {
      const btn = e.target;
      if (btn.classList.contains('btn-increase') || btn.classList.contains('btn-decrease')) {
        const name = btn.dataset.name;
        document.querySelectorAll(`[data-name="${name}"]`).forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
      } else if (btn.classList.contains('btn-clear')) {
        const name = btn.dataset.name;
        document.getElementById(`input-${name}`).value = '';
        document.querySelectorAll(`[data-name="${name}"]`).forEach(b => b.classList.remove('selected'));
      }
    });
  </script>
</body>
</html>
